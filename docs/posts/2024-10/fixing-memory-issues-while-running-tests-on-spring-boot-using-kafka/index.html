<!doctype html><html lang=en><head><meta charset=utf-8><title>Fixing memory issues while running tests on Spring Boot using Kafka - rapatao.com</title>
<meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href=https://www.rapatao.com/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.rapatao.com/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.rapatao.com/favicon/favicon-16x16.png><link rel=manifest href=https://www.rapatao.com/favicon/site.webmanifest><link rel=mask-icon href=https://www.rapatao.com/favicon/safari-pinned-tab.svg color=#ffffff><link rel="shortcut icon" href=https://www.rapatao.com/favicon/favicon.ico><meta name=msapplication-config content="/favicon/browserconfig.xml"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.135.0"><meta itemprop=name content="Fixing memory issues while running tests on Spring Boot using Kafka"><meta itemprop=description content="Recently, I faced a problem in an application where it was taking too long to run its tests. After checking the reasons, I found out that the embedded Kafka provided by Spring was consuming too much memory, making it hard for the GC to free up space to allow all the remaining tests to execute.
That embedded solution worked fine at the beginning of the project, where a few test cases really needed to use that resource to validate its use cases. As soon as the project gets bigger and more test cases are required to use that resource, an issue with the testing execution starts to show up, and the test execution time is drastically starting to increase."><meta itemprop=datePublished content="2024-10-05T20:00:00+00:00"><meta itemprop=dateModified content="2024-10-05T20:00:00+00:00"><meta itemprop=wordCount content="1715"><meta itemprop=image content="https://www.rapatao.com/images/posts/pexels-bentonphotocinema-1095601.jpg"><meta itemprop=keywords content="Tests,Spring,Testcontainers,Kafka"><meta property="og:url" content="https://www.rapatao.com/posts/2024-10/fixing-memory-issues-while-running-tests-on-spring-boot-using-kafka/"><meta property="og:site_name" content="rapatao.com"><meta property="og:title" content="Fixing memory issues while running tests on Spring Boot using Kafka"><meta property="og:description" content="Recently, I faced a problem in an application where it was taking too long to run its tests. After checking the reasons, I found out that the embedded Kafka provided by Spring was consuming too much memory, making it hard for the GC to free up space to allow all the remaining tests to execute.
That embedded solution worked fine at the beginning of the project, where a few test cases really needed to use that resource to validate its use cases. As soon as the project gets bigger and more test cases are required to use that resource, an issue with the testing execution starts to show up, and the test execution time is drastically starting to increase."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-05T20:00:00+00:00"><meta property="article:modified_time" content="2024-10-05T20:00:00+00:00"><meta property="article:tag" content="Tests"><meta property="article:tag" content="Spring"><meta property="article:tag" content="Testcontainers"><meta property="article:tag" content="Kafka"><meta property="og:image" content="https://www.rapatao.com/images/posts/pexels-bentonphotocinema-1095601.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.rapatao.com/images/posts/pexels-bentonphotocinema-1095601.jpg"><meta name=twitter:title content="Fixing memory issues while running tests on Spring Boot using Kafka"><meta name=twitter:description content="Recently, I faced a problem in an application where it was taking too long to run its tests. After checking the reasons, I found out that the embedded Kafka provided by Spring was consuming too much memory, making it hard for the GC to free up space to allow all the remaining tests to execute.
That embedded solution worked fine at the beginning of the project, where a few test cases really needed to use that resource to validate its use cases. As soon as the project gets bigger and more test cases are required to use that resource, an issue with the testing execution starts to show up, and the test execution time is drastically starting to increase."><meta name=twitter:site content="@rapatao"><link rel=stylesheet href=https://www.rapatao.com/css/bundle.min.abec8fc14efbbe295ed4aff7e54c6826d504ca159ff3d50a0c00edff78a8e2c9.css integrity="sha256-q+yPwU77vile1K/35UxoJtUEyhWf89UKDADt/3io4sk="><link rel=stylesheet href=https://www.rapatao.com/css/add-on.css></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=https://www.rapatao.com/ class=nav>rapatao.com</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=https://www.rapatao.com/posts/ class="nav link"><i class='far fa-newspaper'></i> Blog</a>
<a href=https://www.rapatao.com/resume/ class="nav link"><i class='far fa-file-alt'></i> Resume</a>
<a href=https://www.rapatao.com/json/ class="nav link"><i class='far fa-file-code'></i> JSON Formatter & Minifier</a>
<a href=#share-menu class="nav link share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
<a href=#search-input class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a></menu><a href=#search-input class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
<a href=#share-menu class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
<a href=#lang-menu class="nav lang-toggle" lang=en>en</a>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav><menu id=search class=menu><input id=search-input class="search-input menu"></input><div id=search-results class="search-results menu"></div></menu><menu id=lang-menu class="flyout-menu menu"><a href=# lang=en class="nav link active">English (en)</a>
<a href=https://www.rapatao.com/pt lang=pt class="nav no-lang link">Português (pt)</a></menu><menu id=share-menu class="flyout-menu menu"><h1>Share Post</h1><a href="//twitter.com/share?text=Fixing%20memory%20issues%20while%20running%20tests%20on%20Spring%20Boot%20using%20Kafka&amp;url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.reddit.com/submit?url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f&amp;title=Fixing%20memory%20issues%20while%20running%20tests%20on%20Spring%20Boot%20using%20Kafka" target=_blank rel=noopener class="nav share-btn reddit"><p>Reddit</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f&amp;title=Fixing%20memory%20issues%20while%20running%20tests%20on%20Spring%20Boot%20using%20Kafka" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a><a href="mailto:?subject=Check%20out%20this%20post%20by &amp;body=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f" target=_blank class="nav share-btn email" data-proofer-ignore><p>Email</p></a></menu></header><div id=wrapper><section id=site-intro><a href=https://www.rapatao.com/><img src=https://www.rapatao.com/images/avatar-pixel.gif class=square width=100 alt="Luiz H. Rapatão"></a><header><h1>Luiz H. Rapatão</h1></header><main><p>Staff Software Engineer</p></main><footer><ul class=socnet-icons><li><a href=//github.com/rapatao target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//linkedin.com/in/rapatao target=_blank rel=noopener title=LinkedIn class="fab fa-linkedin"></a></li><li><a href=//instagram.com/luizrapatao target=_blank rel=noopener title=Instagram class="fab fa-instagram"></a></li><li><a href=//twitter.com/rapatao target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li><li><a href=mailto:rapatao@rapatao.com target=_blank title=Email class="far fa-envelope"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=https://www.rapatao.com/posts/2024-10/fixing-memory-issues-while-running-tests-on-spring-boot-using-kafka/>Fixing memory issues while running tests on Spring Boot using Kafka</a></h2></div><div class=meta><time datetime="2024-10-05 20:00:00 +0000 UTC">October 5, 2024</time><p>9-Minute Read</p></div></header><div id=socnet-share><a href="//twitter.com/share?text=Fixing%20memory%20issues%20while%20running%20tests%20on%20Spring%20Boot%20using%20Kafka&amp;url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.reddit.com/submit?url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f&amp;title=Fixing%20memory%20issues%20while%20running%20tests%20on%20Spring%20Boot%20using%20Kafka" target=_blank rel=noopener class="nav share-btn reddit"><p>Reddit</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f&amp;title=Fixing%20memory%20issues%20while%20running%20tests%20on%20Spring%20Boot%20using%20Kafka" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a><a href="mailto:?subject=Check%20out%20this%20post%20by &amp;body=https%3a%2f%2fwww.rapatao.com%2fposts%2f2024-10%2ffixing-memory-issues-while-running-tests-on-spring-boot-using-kafka%2f" target=_blank class="nav share-btn email" data-proofer-ignore><p>Email</p></a></div><div class=content><a href=https://www.rapatao.com/posts/2024-10/fixing-memory-issues-while-running-tests-on-spring-boot-using-kafka/ class=image style="--bg-image:url('https://www.rapatao.com/images/posts/pexels-bentonphotocinema-1095601.jpg')"><img class=stretchV src=https://www.rapatao.com/images/posts/pexels-bentonphotocinema-1095601.jpg alt="Fixing memory issues while running tests on Spring Boot using Kafka"></a><p>Recently, I faced a problem in an application where it was taking too long to run its tests. After checking the reasons,
I found out that the embedded Kafka provided by Spring was consuming too much memory, making it hard for the GC to free
up space to allow all the remaining tests to execute.</p><p>That embedded solution worked fine at the beginning of the project, where a few test cases really needed to use that
resource to validate its use cases. As soon as the project gets bigger and more test cases are required to use that
resource, an issue with the testing execution starts to show up, and the test execution time is drastically starting to
increase.</p><p><img alt="please sir, can I have some more memory?" src=https://www.rapatao.com/images/posts/please-sir-can-i-have-some-more-memory.png#center></p><p>Ok, the issue was identified, so how can it be fixed? Initially, I thought, let&rsquo;s increase the memory allocated to run
those tests, and it should resolve the issue! But how much memory should I add? Will it be future-proof? More tests will
be added soon, and will that issue occur again?</p><p>After thinking about it for a while, I remembered that I use <code>testcontainers</code> on other applications and also on my
Golang projects, so I decided to give it a try using it on this application.</p><h2 id=adding-testcontainers-to-the-project>Adding testcontainers to the project</h2><p>As usual, I went to the official documentation to read about that integration, and then I sadly discovered that, to use
it, a considerable change would be required.</p><p>To use the embedded solution, only an annotation is required, but now, it will require not only an annotation, but also
some lines of code to allow overriding the default Kafka bootstrap URLs present in the Spring context.</p><p>To give context to it, each testing class that requires Kafka adds a single annotation describing the topic used in the
test.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EmbeddedKafka</span>(partitions = <span style=color:#ae81ff>1</span>, topics = [<span style=color:#e6db74>&#34;topic-name&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CasesTests</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// testing code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>The next step is replacing it with the <code>testcontainers</code> implementation; each test class must now have the following
code, which didn&rsquo;t include the topic creation that was essential in most of the use cases.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Testcontainers</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CasesTests</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>companion</span> <span style=color:#66d9ef>object</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Container</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> kafka = KafkaContainer(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>DockerImageName</span>.parse(<span style=color:#e6db74>&#34;apache/kafka:latest&#34;</span>)
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@DynamicPropertySource</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@JvmStatic</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>overrideProperties</span>(registry: DynamicPropertyRegistryy) {
</span></span><span style=display:flex><span>            registry.add(<span style=color:#e6db74>&#34;spring.kafka.bootstrap-servers&#34;</span>, kafka.bootstrapServers);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// testing code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Although it didn&rsquo;t seem like much code and could probably be shared between the test classes by composing the companion
object, it still has the problem of creating the topic required in each test case.</p><p>You may be starting to ask how to address all those “issues”, right? Keep reading, and you will get the answer.</p><h2 id=lets-use-junit-instead>Let&rsquo;s use JUnit instead</h2><p>In <a href=https://www.rapatao.com/posts/2022-01/build-tests-using-kotlin-junit-mockk/>this post</a>, I mentioned that JUnit has some
useful annotations that allow us to run operations before or after our test cases. Those are the annotations:</p><ul><li><code>@BeforeEach</code>: execute before each method</li><li><code>@BeforeAll</code>: execute before all test methods</li><li><code>@AfterEach</code>: execute after each method</li><li><code>@AfterAll</code>: execute after all test methods</li></ul><p>At this point, you are probably thinking that these annotations could be used to create the topics, and you are correct!
By using it before running the test cases, the required topics could be created, but it still requires adding many
instructions to the existing classes, and I would rather not do it.</p><p>So, it comes to mind implementing a custom JUnit callback that will read the metadata defined on an annotation to handle
all of it. Sounds great, right? Let&rsquo;s start coding.</p><p>First, I created the following annotation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>annotation</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EnableKafkaTopics</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> partitions: Int = <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vararg</span> <span style=color:#66d9ef>val</span> topics: String = [],
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>As you could see, it has basically the same signature as the <code>@EmbeddedKafka</code> one, which would allow me to only replace
the annotation and still have everything working as before.</p><p>Now that the annotation is defined, let&rsquo;s create the JUnit extension to read that and create the topics.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KafkaTopicsExtension</span> : BeforeEachCallback {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>beforeEach</span>(context: ExtensionContext) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// find the annotation from the testing class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>val</span> definition = <span style=color:#a6e22e>TestContextAnnotationUtils</span>.findMergedAnnotation(
</span></span><span style=display:flex><span>            context.testClass.<span style=color:#66d9ef>get</span>(),
</span></span><span style=display:flex><span>            EnableKafkaTopics<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java,
</span></span><span style=display:flex><span>        )<span style=color:#f92672>!!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// define the topic creation using the annotation metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>val</span> topics = definition.topics.map { NewTopic(<span style=color:#66d9ef>it</span>, definition.partitions, <span style=color:#ae81ff>1</span>) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// get KafkaAdmin bean from the Spring context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>val</span> kafkaAdmin = <span style=color:#a6e22e>SpringExtension</span>.getApplicationContext(context).getBean(KafkaAdmin<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// create topics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        kafkaAdmin.createOrModifyTopics(*topics.toTypedArray())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With the extension implemented, I changed the <code>EnableKafkaTopics</code> annotation to refer to the desired extension.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(KafkaTopicsExtension<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>annotation</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EnableKafkaTopics</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> partitions: Int = <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vararg</span> <span style=color:#66d9ef>val</span> topics: String = [],
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>At this point, I completely forgot that I should append to the test class the companion object to start the container
and just went to the code and replaced it within my new <code>EnableKafkaTopics</code> annotation.</p><p>As you could imagine, the test failed because no container started, no topic was created, and consequently, the test
case failed.</p><p>So, there I go. Since changing it on all classes just for testing would be harder, I opened a single test class, added
the companion object declaration to start the container, and <em>voilà</em>, all tests on it passed.</p><p>After all this work, I was happy that it worked but wished to make it easier to replace the embedded solution with this
new one and, somehow, make it future-proof, simplifying its usage on newer test classes.</p><h2 id=spring-context-customizers-is-the-solution>Spring Context Customizers is the solution</h2><p>That was what I thought at the time, so I ended by creating a customizer that initializes the container and replaces the
bootstrap address in the Spring context.</p><p>The following code does exactly that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KafkaContainerContextCustomizerFactory</span> : ContextCustomizerFactory {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createContextCustomizer</span>(
</span></span><span style=display:flex><span>        testClass: Class&lt;*&gt;,
</span></span><span style=display:flex><span>        configAttributes: MutableList&lt;ContextConfigurationAttributes&gt;
</span></span><span style=display:flex><span>    ): ContextCustomizer? {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// try to find the annotation from the test running class, otherwise, return null without initializing the container
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>TestContextAnnotationUtils</span>.findMergedAnnotation(testClass, EnableKafkaTopics<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java) <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// create kafka and start container
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>val</span> container = KafkaContainer(<span style=color:#a6e22e>DockerImageName</span>.parse(<span style=color:#e6db74>&#34;confluentinc/cp-kafka:latest&#34;</span>))
</span></span><span style=display:flex><span>        container.start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// create and return context customizer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> KafkaContainerContextCustomizer(container)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inner</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KafkaContainerContextCustomizer</span>(<span style=color:#66d9ef>val</span> container: KafkaContainer) : ContextCustomizer {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>customizeContext</span>(
</span></span><span style=display:flex><span>            context: ConfigurableApplicationContext,
</span></span><span style=display:flex><span>            mergedConfig: MergedContextConfiguration
</span></span><span style=display:flex><span>        ) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// add the bootstrap servers at the top of the properties
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            context.environment.propertySources.addFirst(
</span></span><span style=display:flex><span>                MapPropertySource(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;kafka&#34;</span>, mapOf(<span style=color:#e6db74>&#34;spring.kafka.bootstrap-servers&#34;</span> to container.bootstrapServers),
</span></span><span style=display:flex><span>                ),
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It is necessary to create a <code>spring.factories</code> inside the <code>META-INF</code> folder to activate this factory. The content of the
file must be something like this:</p><pre tabindex=0><code>org.springframework.test.context.ContextCustomizerFactory=\
  com.rapatao.www.KafkaContainerContextCustomizerFactory
</code></pre><p>At first glance, I thought that I had found the perfect solution, so I replaced the annotation on all testing cases and
ran the building to ensure that all tests would succeed.</p><p>As it started running, most of the tests were being executed successfully, but at some point, they started to fail due
to a lack of memory. I started the investigation because, in my mind, it shouldn&rsquo;t happen until I realized the problem.</p><p>I was starting the containers but never stopping them because, I was expecting that the <code>testcontainers</code> controller
would stop them automatically, which it actually does, but only when the execution finishes, which in my case, is when
all tests finish.</p><p>At this point, I was too tired, so I decided to go simple. Since it was only used for testing, I created a static map to
store the test class and its container instance and extended the <code>KafkaTopicsExtension</code> to stop this container after the
test execution.</p><p>It worked, but I will not cover these changes in the article because, when I was rewriting the solution to have some
code snippets to add in this text, I ended up finding a better solution.</p><h2 id=spring-test-configuration>Spring Test Configuration</h2><p>Similar to the <code>@Configuration</code> which is normally used to create beans and expose some other kinds of customizations in
the productive code, the <code>@TestConfiguration</code> does the same, but it is used in the test code.</p><p>Spring Boot has an integration package that allows overriding those variables by simply adding the <code>@ServiceConnection</code>
annotation. So, to initialize a Kafka container, all I have to do is add the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KafkaContainerConfiguration</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ServiceConnection</span> <span style=color:#75715e>// It does all the magic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>kafkaContainer</span>(): KafkaContainer {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> KafkaContainer(<span style=color:#a6e22e>DockerImageName</span>.parse(<span style=color:#e6db74>&#34;confluentinc/cp-kafka:latest&#34;</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you probably noticed, the given snippet isn&rsquo;t annotating the class with the <code>@TestConfiguration</code> and it was
intentional, so we can decide whether to enable or not the Kafka integration since some of our tests don&rsquo;t require the
Kafka to run and activating them would make them slower.</p><p>Since all tests that require the Kafka container are annotated with the <code>@EnableKafkaTopics</code>, we can adapt it to import
that configuration, which ends by activating the container when necessary.</p><p>The final code for the annotation is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@Import</span>(KafkaContainerConfiguration<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(KafkaTopicsExtension<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>annotation</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EnableKafkaTopics</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> partitions: Int = <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>vararg</span> <span style=color:#66d9ef>val</span> topics: String = [],
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>The issue itself was challenging, something that I&rsquo;ve never experienced in my coder life, and I was really joyful
reading the documentation of something that I have not been using for so long and has so many changes.</p><p>I forgot some basic stuff that I usually recommend to everyone I talk to, which is to first read about the topic in the
official documentation of the tool that you are using.</p><p>In my situation, it would probably make me not create the customizer I created, but instead use the annotation the
Spring Boot testing package provides exactly for this purpose.</p><p>In my defense, as if I needed one, I read the <code>testcontainers</code> documentation, and there, I didn&rsquo;t find anything about
that annotation that I just discovered when writing this post. This is probably something relatively new, but I will not
find out; there&rsquo;s no reason for it.</p><p>Anyway, everything that happened was good; it helped me to relearn topics that I had forgotten and also helped me to
write a text for this site, something that I did for the last time, almost a year ago.</p><p>I hope it helped you learn, or at least review, some of the topics presented in this post. It may be a good learning
experience if you have never created a custom JUnit extension or even declared a Spring Customizer Factory.</p><p>Thanks for reading it; see you soon.</p><h2 id=references>References</h2><h3 id=links>Links</h3><ul><li><a href=https://docs.spring.io/spring-kafka/reference/testing.html#embedded-kafka-junit5>@EmbeddedKafka Annotation with JUnit5</a></li><li><a href=https://testcontainers.com/guides/testing-spring-boot-kafka-listener-using-testcontainers/>Testing Spring Boot Kafka Listener using Testcontainers</a></li><li><a href=https://docs.spring.io/spring-framework/reference/testing/testcontext-framework/ctx-management/initializers.html>Context Configuration with Context Initializers</a></li><li><a href=https://docs.spring.io/spring-boot/api/java/org/springframework/boot/test/context/TestConfiguration.html>Annotation Interface TestConfiguration</a></li></ul><h3 id=gradle-plugins-and-dependencies>Gradle plugins and dependencies</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-gradle data-lang=gradle><span style=display:flex><span>plugins <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    id <span style=color:#e6db74>&#39;org.jetbrains.kotlin.jvm&#39;</span> version <span style=color:#e6db74>&#39;1.9.25&#39;</span>
</span></span><span style=display:flex><span>    id <span style=color:#e6db74>&#39;org.jetbrains.kotlin.plugin.spring&#39;</span> version <span style=color:#e6db74>&#39;1.9.25&#39;</span>
</span></span><span style=display:flex><span>    id <span style=color:#e6db74>&#39;org.springframework.boot&#39;</span> version <span style=color:#e6db74>&#39;3.3.4&#39;</span>
</span></span><span style=display:flex><span>    id <span style=color:#e6db74>&#39;io.spring.dependency-management&#39;</span> version <span style=color:#e6db74>&#39;1.1.6&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter&#39;</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.jetbrains.kotlin:kotlin-reflect&#39;</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.kafka:spring-kafka&#39;</span>
</span></span><span style=display:flex><span>    testImplementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-test&#39;</span>
</span></span><span style=display:flex><span>    testImplementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-testcontainers&#39;</span>
</span></span><span style=display:flex><span>    testImplementation <span style=color:#e6db74>&#39;org.testcontainers:junit-jupiter&#39;</span>
</span></span><span style=display:flex><span>    testImplementation <span style=color:#e6db74>&#39;org.testcontainers:kafka&#39;</span>
</span></span><span style=display:flex><span>    testRuntimeOnly <span style=color:#e6db74>&#39;org.junit.platform:junit-platform-launcher&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div><footer><div class=stats><ul class=tags><li><a class=article-terms-link href=https://www.rapatao.com/tags/tests/>tests</a></li><li><a class=article-terms-link href=https://www.rapatao.com/tags/spring/>spring</a></li><li><a class=article-terms-link href=https://www.rapatao.com/tags/testcontainers/>testcontainers</a></li><li><a class=article-terms-link href=https://www.rapatao.com/tags/kafka/>kafka</a></li></ul></div></footer></article><article class=post><div id=reaktions></div><script lang=application/javascript defer src=https://reaktions.rapatao.com/reaktions.js></script><noscript>Please enable JavaScript to react with this post</noscript></article><article class=post><script src=https://giscus.app/client.js data-repo=rapatao/rapatao.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk1NjIwMDMzMQ==" data-category="Post Discussions" data-category-id=DIC_kwDOA1mMi84CjFm8 data-mapping=pathname data-strict=0 data-reactions-enabled=0 data-emit-metadata data-input-position=bottom data-theme=noborder_light data-lang=en crossorigin=anonymous async></script></article><div class=pagination><a href=https://www.rapatao.com/posts/2023-11/destructuring-in-kotlin/ class="button right"><span>Destructuring in Kotlin</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>Recent Posts</h1></header><article class=mini-post><a href=https://www.rapatao.com/posts/2024-10/fixing-memory-issues-while-running-tests-on-spring-boot-using-kafka/ class=image style="--bg-image:url('https://www.rapatao.com/images/posts/pexels-bentonphotocinema-1095601.jpg')"><img class=stretchV src=https://www.rapatao.com/images/posts/pexels-bentonphotocinema-1095601.jpg alt="Fixing memory issues while running tests on Spring Boot using Kafka"></a><header><h2><a href=https://www.rapatao.com/posts/2024-10/fixing-memory-issues-while-running-tests-on-spring-boot-using-kafka/>Fixing memory issues while running tests on Spring Boot using Kafka</a></h2><time class=published datetime="2024-10-05 20:00:00 +0000 UTC">October 5, 2024</time></header></article><article class=mini-post><a href=https://www.rapatao.com/posts/2023-11/destructuring-in-kotlin/ class=image style="--bg-image:url('https://www.rapatao.com/images/posts/pexels-cottonbro-studio-3944307.jpg')"><img class=stretchV src=https://www.rapatao.com/images/posts/pexels-cottonbro-studio-3944307.jpg alt="Destructuring in Kotlin"></a><header><h2><a href=https://www.rapatao.com/posts/2023-11/destructuring-in-kotlin/>Destructuring in Kotlin</a></h2><time class=published datetime="2023-11-10 17:00:00 +0000 UTC">November 10, 2023</time></header></article><article class=mini-post><a href=https://www.rapatao.com/posts/2023-10/contract-first-vs-code-first-api-documentation/ class=image style="--bg-image:url('https://www.rapatao.com/images/posts/pexels-rdne-stock-project-7841410.jpg')"><img class=stretchV src=https://www.rapatao.com/images/posts/pexels-rdne-stock-project-7841410.jpg alt="Contract-First VS Code-First API Documentation"></a><header><h2><a href=https://www.rapatao.com/posts/2023-10/contract-first-vs-code-first-api-documentation/>Contract-First VS Code-First API Documentation</a></h2><time class=published datetime="2023-10-08 09:00:00 +0000 UTC">October 8, 2023</time></header></article><footer><a href=https://www.rapatao.com/posts/ class=button>See More</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/rapatao target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//linkedin.com/in/rapatao target=_blank rel=noopener title=LinkedIn class="fab fa-linkedin"></a></li><li><a href=//instagram.com/luizrapatao target=_blank rel=noopener title=Instagram class="fab fa-instagram"></a></li><li><a href=//twitter.com/rapatao target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li><li><a href=mailto:rapatao@rapatao.com target=_blank title=Email class="far fa-envelope"></a></li></ul><p class=copyright>© 2024 rapatao.com</p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=https://www.rapatao.com/js/bundle.min.81b0671483f52a7cb71722e0708deb2d07f9d7ccf2b1f6b5ab49c3a30f392aa8.js integrity="sha256-gbBnFIP1Kny3FyLgcI3rLQf518zysfa1q0nDow85Kqg="></script><script src=https://www.rapatao.com/js/add-on.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "8575ea838221496eb4ac5f867d0d5d8f"}'></script></div></body></html data-check="rapatao.com">
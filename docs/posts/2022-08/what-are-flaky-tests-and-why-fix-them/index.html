<!doctype html><html lang=en><head><meta charset=utf-8><title>What are Flaky Tests and why fix them! - rapatao.com</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href=https://www.rapatao.com/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.rapatao.com/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.rapatao.com/favicon/favicon-16x16.png><link rel=manifest href=https://www.rapatao.com/favicon/site.webmanifest><link rel=mask-icon href=https://www.rapatao.com/favicon/safari-pinned-tab.svg color=#ffffff><link rel="shortcut icon" href=https://www.rapatao.com/favicon/favicon.ico><meta name=msapplication-config content="/favicon/browserconfig.xml"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.105.0"><meta itemprop=name content="What are Flaky Tests and why fix them!"><meta itemprop=description content="Building tests is surely one of the most difficult and time-consuming tasks for a developer, in addition to usually generating more lines of code than the added functionality. This is due to the various scenarios that need, or should, be verified.
Flaky Tests, are basically test cases created to verify a scenario, however, they can randomly present success and failure results, without having undergone any change, neither in the test case nor in the tested code."><meta itemprop=datePublished content="2022-08-28T12:00:00-03:00"><meta itemprop=dateModified content="2022-08-28T12:00:00-03:00"><meta itemprop=wordCount content="1593"><meta itemprop=image content><meta itemprop=keywords content="tests,"><meta property="og:title" content="What are Flaky Tests and why fix them!"><meta property="og:description" content="Building tests is surely one of the most difficult and time-consuming tasks for a developer, in addition to usually generating more lines of code than the added functionality. This is due to the various scenarios that need, or should, be verified.
Flaky Tests, are basically test cases created to verify a scenario, however, they can randomly present success and failure results, without having undergone any change, neither in the test case nor in the tested code."><meta property="og:type" content="article"><meta property="og:url" content="https://www.rapatao.com/posts/2022-08/what-are-flaky-tests-and-why-fix-them/"><meta property="og:image" content="https://www.rapatao.com/images/posts/flaky-pipeline.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-28T12:00:00-03:00"><meta property="article:modified_time" content="2022-08-28T12:00:00-03:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.rapatao.com/images/posts/flaky-pipeline.png"><meta name=twitter:title content="What are Flaky Tests and why fix them!"><meta name=twitter:description content="Building tests is surely one of the most difficult and time-consuming tasks for a developer, in addition to usually generating more lines of code than the added functionality. This is due to the various scenarios that need, or should, be verified.
Flaky Tests, are basically test cases created to verify a scenario, however, they can randomly present success and failure results, without having undergone any change, neither in the test case nor in the tested code."><meta name=twitter:site content="@rapatao"><link rel=stylesheet href=https://www.rapatao.com/css/bundle.min.4ff4389274ff79a3a51d36b6c29b74b72da08fa3b64251dd1521a7691d0e6223.css integrity="sha256-T/Q4knT/eaOlHTa2wpt0ty2gj6O2QlHdFSGnaR0OYiM="><link rel=stylesheet href=https://www.rapatao.com/css/add-on.css><link rel=alternate hreflang=en href=https://www.rapatao.com/posts/2022-08/what-are-flaky-tests-and-why-fix-them/><link rel=alternate hreflang=pt href=https://www.rapatao.com/pt/posts/2022-08/o-que-sao-flaky-tests-e-porque-corrigi-los/></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=https://www.rapatao.com/ class=nav>rapatao.com</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=https://www.rapatao.com/pt/posts/ class="nav link"><i class='far fa-newspaper'></i> Blog</a>
<a href=https://www.rapatao.com/resume/ class="nav link"><i class='far fa-file-alt'></i> Resume</a>
<a href=https://www.rapatao.com/json/ class="nav link"><i class='far fa-file-code'></i> JSON Formatter & Minifier</a>
<a href=#share-menu class="nav link share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
<a href=#search-input class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a></menu>
<a href=#search-input class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
<a href=#share-menu class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
<a href=#lang-menu class="nav lang-toggle" lang=en>en</a>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav><menu id=search class=menu><input id=search-input class="search-input menu"></input><div id=search-results class="search-results menu"></div></menu><menu id=lang-menu class="flyout-menu menu"><a href=# lang=en class="nav link active">English (en)</a>
<a href=https://www.rapatao.com/pt/posts/2022-08/o-que-sao-flaky-tests-e-porque-corrigi-los/ lang=pt class="nav link">Português (pt)</a></menu>
<menu id=share-menu class="flyout-menu menu"><h1>Share Post</h1><a href="//twitter.com/share?text=What%20are%20Flaky%20Tests%20and%20why%20fix%20them%21&url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.reddit.com/submit?url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f&title=What%20are%20Flaky%20Tests%20and%20why%20fix%20them%21" target=_blank rel=noopener class="nav share-btn reddit"><p>Reddit</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f&title=What%20are%20Flaky%20Tests%20and%20why%20fix%20them%21" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a><a href="mailto:?subject=Check%20out%20this%20post%20by %7b%20%20%20%20%20%20%20%20map%5b%5d%7d&body=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f" target=_blank class="nav share-btn email" data-proofer-ignore><p>Email</p></a></menu></header><div id=wrapper><section id=site-intro><a href=https://www.rapatao.com/><img src=https://www.rapatao.com/images/avatar-pixel.gif class=square width=100 alt="Luiz H. Rapatão"></a><header><h1>Luiz H. Rapatão</h1></header><main><p>Senior Software Engineer</p></main><footer><ul class=socnet-icons><li><a href=//github.com/rapatao target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//linkedin.com/in/rapatao target=_blank rel=noopener title=LinkedIn class="fab fa-linkedin"></a></li><li><a href=//instagram.com/luizrapatao target=_blank rel=noopener title=Instagram class="fab fa-instagram"></a></li><li><a href=//twitter.com/rapatao target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li><li><a href=mailto:rapatao@rapatao.com target=_blank title=Email class="far fa-envelope"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=https://www.rapatao.com/posts/2022-08/what-are-flaky-tests-and-why-fix-them/>What are Flaky Tests and why fix them!</a></h2></div><div class=meta><time datetime="2022-08-28 12:00:00 -0300 -03">August 28, 2022</time><p>8-Minute Read</p></div></header><div id=socnet-share><a href="//twitter.com/share?text=What%20are%20Flaky%20Tests%20and%20why%20fix%20them%21&url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.reddit.com/submit?url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f&title=What%20are%20Flaky%20Tests%20and%20why%20fix%20them%21" target=_blank rel=noopener class="nav share-btn reddit"><p>Reddit</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f&title=What%20are%20Flaky%20Tests%20and%20why%20fix%20them%21" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a><a href="mailto:?subject=Check%20out%20this%20post%20by %7b%20%20%20%20%20%20%20%20map%5b%5d%7d&body=https%3a%2f%2fwww.rapatao.com%2fposts%2f2022-08%2fwhat-are-flaky-tests-and-why-fix-them%2f" target=_blank class="nav share-btn email" data-proofer-ignore><p>Email</p></a></div><div class=content><a href=https://www.rapatao.com/posts/2022-08/what-are-flaky-tests-and-why-fix-them/ class=image style="--bg-image:url('https://www.rapatao.com/images/posts/flaky-pipeline.png')"><img src=https://www.rapatao.com/images/posts/flaky-pipeline.png alt="What are Flaky Tests and why fix them!"></a><p>Building tests is surely one of the most difficult and time-consuming tasks for a developer, in addition to usually generating more lines of code than the added functionality. This is due to the various scenarios that need, or should, be verified.</p><p><em>Flaky Tests</em>, are basically test cases created to verify a scenario, however, they can randomly present success and failure results, without having undergone any change, neither in the test case nor in the tested code.</p><p>Basically, they are those test cases that fail for no reason and, on re-execution, complete successfully.</p><p>Several reasons can cause a test case to be inconsistent, let&rsquo;s address some of the main causes I&rsquo;ve experienced below.</p><h2 id=when-the-order-of-execution-matters>When the order of execution matters</h2><p><img src=https://www.rapatao.com/images/posts/pexels-shy-sol-65562.jpg#floatleft alt="When play order matters"></p><p>It is common to build a class and add methods for the different cases to be tested, however, especially when we access databases or classes that store the state, the execution of a test case can change these persisted data and, consequently, impact the desired result in the next test run.</p><p>Perhaps this is one of the easiest cases to solve, where we can just define the order of execution of these test cases, or even perform a cleaning and preparation of the data before the execution of each test case.</p><p>In particular, I understand that a test case should not impact another case and I usually tend to use data cleaning and preparation routines before executing each case. However, I understand that in some cases, defining an execution order could greatly reduce the effort required to build test cases.</p><p>An example where the order might make sense would be to test a <em>CRUD</em>, where you can create a first case where we create the resource, in the second we retrieve it, in the third we would update it and finally we would delete it. As for business rules validation cases, such as performing calculations or other complex checks, I believe that cleaning and preparation routines are the best option, as it simplifies the understanding of the initial state without the need to analyze the previous test case, disregarding , that many times, the previously executed test does not have much relation with the initial state to be tested in the current case.</p><p>I don&rsquo;t believe there is a right or wrong, but different approaches. The most important thing is to understand their differences and identify where a solution can best be applied.</p><h2 id=dates-and-time-zones-are-always-tricky>Dates and time zones are always tricky</h2><p><img src=https://www.rapatao.com/images/posts/pexels-andrey-grushnikov-707676.jpg#floatright alt="Dates and time zones are always tricky"></p><p>If you have a team that works in different locations, with different time zones, or your CI/CD is in a different time zone than yours, there is a high chance that you have already suffered from test problems that validate dates. This problem is also common to happen in leap years or beginnings of month.</p><p>There are several ways to solve this problem, but in general, it consists of modifying how the validation of dates is performed, in order to be able to control the &ldquo;clock&rdquo;, that is, define the current moment and, consequently, have control of validations involving date. .</p><p>In Java, for example, when retrieving the current moment, it is common to use the following block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> Instant now <span style=color:#f92672>=</span> Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>However, it is possible to control the &ldquo;clock&rdquo; by changing to the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> Instant now <span style=color:#f92672>=</span> Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>(</span>clock<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>With this, in our test cases, we just build a <em>mock</em> of <code>java.time.Clock</code> to return a specific date, that is, we have control of the &ldquo;clock&rdquo; and ensure validation of a specific scenario in the test case , regardless of where in the time zone or day the due case is being executed.</p><h2 id=synchronization-in-async>Synchronization in Async</h2><p><img src=https://www.rapatao.com/images/posts/pexels-connor-martin-5526115.jpg#floatleft alt="Sync in Async"></p><p>The use of asynchronous methods has increasingly become routine in application development, given that in many cases, some processes could be executed in parallel, without blocking other operations or even user actions.</p><p>However, ensuring that an asynchronous method performed some operation as desired is often a difficult task, since, as it executes at another time, we have no control over when it will be performed, which, depending on the computational capacity, can lead to failures by advance checks. For example, an asynchronous method should persist information in the database, however, at the moment we check, this insertion has not yet occurred, resulting in a failure, however, some time later, the information is inserted correctly.</p><p>The difficulty in this type of test is to identify the moment to verify that something has happened, since we have no way of controlling when it will occur. There are several ways to try to ensure that processing has completed before performing the checks, the most common is also the way that I believe is the one we should avoid. That is, block the process for a certain time, using, for example, Java&rsquo;s <code>Thread.sleep(long)</code>.</p><p>The problem with this approach is that, if the processing completes in 1 second, but we define 60 seconds there, the test case will always take the maximum time to complete and when we replicate this approach for all tests, we end up multiplying the time needed for execution of the tests.</p><p>I believe that not all the tools that you may be using have support for checking asynchronous processes, and in certain cases, the use of the aforementioned method may be acceptable, but whenever possible, we should opt for optimized approaches that aim not to block the process. for a specific time, but up to a maximum time limit, performing the checks when it is completed in advance.</p><p>An example of a tool that supports this type of validation would be <em><a href=https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html#22>Mockito</a></em> which offers verification using <code>timeout(long)</code>, which ends the verification if it occurs within the specified time or fails if it does not.</p><h2 id=end-to-end-tests>End-to-end tests</h2><p><img src=https://www.rapatao.com/images/posts/pexels-clark-cruz-2911364.jpg#floatright alt="End-to-End Tests"></p><p>As it is a type of test that integrates with other applications/services, it is naturally a <em>Flaky Test</em> and we hardly have an ideal solution for these cases, consequently requiring analysis for confirmation.</p><p>Precisely because it integrates with other systems, we have several factors involved that can cause a given test case not to have the expected result, which consequently generates a validation failure. A common example in this type of test would be a possible network intermittence or a simple unavailability of the consumed service, which makes the case to be tested not possible, resulting in failure.</p><p>As said before, there is not much to do in these cases, building a resilient application, with retries can minimize these problems, however, it is not a guarantee, depending on the cause of the problem. This is exactly why, in these cases, it is always important to analyze the problem to identify if it is something new, that is, due to a code change, or something external that we have no way to control.</p><p>Of course, most of these tests could be converted to tests that use tools that would give us control over the scenarios, allowing us to create simulations to test some specific/necessary case. Often, the use of a real database could be replaced by an in-memory database or an integration to a <em>REST API</em> could be done for a <em>mock</em> created using <em><a href=https://wiremock.org/>WireMock</a></em> instead of the &ldquo;real&rdquo; <em>endpoint</em>.</p><p>In general, these tests are very time consuming in execution and require another considerable time of analysis to confirm if it was a problem introduced in the change or some kind of external intermittence. Reducing the amount of this type of test, I believe, is one of the best solutions to minimize the occurrence of unexpected failures.</p><aside>⚠️ Reducing is not removing! The process of reducing these tests normally consists of adapting these cases to the use of *mocks* and in certain cases, their removal, but this should only be done if another existing test is covering this specific case.</aside><h2 id=why-fix>Why fix?</h2><p><img src=https://www.rapatao.com/images/posts/pexels-ann-h-12347774.jpg#floatleft alt="Why fix?"></p><p>Tests have the function of guaranteeing that a desired behavior is actually happening, that is, if something does what it should do and, consequently, if a change has not impacted this behavior, thus generating problems that can directly impact the users of this system. Another benefit that systems with good code coverage brings is for code refactoring, because, as we have good test cases, we can easily identify when some modification has changed the behavior of the application, so the change must be reanalyzed and in extreme cases, discarded.</p><p>Understanding the advantages mentioned above, when we have test cases that fail randomly, regardless of whether we have changed something or not, we end up losing this confidence in the test cases, because we are never sure whether or not we create a problem in the application with the change that we make. we did, consequently consuming a lot of analysis time to confirm that the test failed due to the change or some test considered <em>Flaky</em>.</p><p>Tests consume execution time, when we come across <em>Flaky Tests</em>, we end up having to execute the test cases more than once for them to finish successfully and this, depending on the case, can consume a large part of your day, especially when we use CI/CD that blocks the merging of our code, when it doesn&rsquo;t successfully execute all the existing test cases, which consequently generates frustration for the developer.</p><p>It is not always easy to identify these cases, but correcting them is important to guarantee confidence in the test cases, bring security in corrections and in the development of new features, in addition to improving productivity, since we have a guarantee that, when our tests fail, it&rsquo;s in fact some new problem that we created and not a burst that, when rerun, disappears.</p></div><footer><div class=stats><ul class=tags><li><a class=article-terms-link href=https://www.rapatao.com/tags/tests/>tests</a></li></ul></div></footer></article><article class=post><div id=reaktions></div><script lang=application/javascript defer src=https://reaktions.rapatao.com/reaktions.js></script><noscript>Please enable JavaScript to react with this post</noscript></article><div class=pagination><a href=https://www.rapatao.com/posts/2022-10/what-is-a-reverse-proxy/ class="button left"><span>What is a Reverse Proxy?</span></a>
<a href=https://www.rapatao.com/posts/2022-07/gnupg-how-to-backup-and-restore-your-keys/ class="button right"><span>GnuPG: how to backup and restore your keys?</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>Recent Posts</h1></header><article class=mini-post><a href=https://www.rapatao.com/posts/2022-10/what-is-a-reverse-proxy/ class=image style="--bg-image:url('https://www.rapatao.com/images/posts/gate-g2919ae08c_640.jpg')"><img src=https://www.rapatao.com/images/posts/gate-g2919ae08c_640.jpg alt="What is a Reverse Proxy?"></a><header><h2><a href=https://www.rapatao.com/posts/2022-10/what-is-a-reverse-proxy/>What is a Reverse Proxy?</a></h2><time class=published datetime="2022-10-22 12:00:00 -0300 -03">October 22, 2022</time></header></article><article class=mini-post><a href=https://www.rapatao.com/posts/2022-08/what-are-flaky-tests-and-why-fix-them/ class=image style="--bg-image:url('https://www.rapatao.com/images/posts/flaky-pipeline.png')"><img src=https://www.rapatao.com/images/posts/flaky-pipeline.png alt="What are Flaky Tests and why fix them!"></a><header><h2><a href=https://www.rapatao.com/posts/2022-08/what-are-flaky-tests-and-why-fix-them/>What are Flaky Tests and why fix them!</a></h2><time class=published datetime="2022-08-28 12:00:00 -0300 -03">August 28, 2022</time></header></article><article class=mini-post><a href=https://www.rapatao.com/posts/2022-07/gnupg-how-to-backup-and-restore-your-keys/ class=image style="--bg-image:url('https://www.rapatao.com/images/posts/pexels-lucas-seebacher-5599449.jpeg')"><img src=https://www.rapatao.com/images/posts/pexels-lucas-seebacher-5599449.jpeg alt="GnuPG: how to backup and restore your keys?"></a><header><h2><a href=https://www.rapatao.com/posts/2022-07/gnupg-how-to-backup-and-restore-your-keys/>GnuPG: how to backup and restore your keys?</a></h2><time class=published datetime="2022-07-31 12:00:00 -0300 -03">July 31, 2022</time></header></article><footer><a href=https://www.rapatao.com/posts/ class=button>See More</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/rapatao target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//linkedin.com/in/rapatao target=_blank rel=noopener title=LinkedIn class="fab fa-linkedin"></a></li><li><a href=//instagram.com/luizrapatao target=_blank rel=noopener title=Instagram class="fab fa-instagram"></a></li><li><a href=//twitter.com/rapatao target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li><li><a href=mailto:rapatao@rapatao.com target=_blank title=Email class="far fa-envelope"></a></li></ul><p class=copyright>© 2022 rapatao.com<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.105.0 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a>
<script src=https://www.rapatao.com/js/bundle.min.294ee8926c7846b7befa87e1420ce7621077417d4ef195df6c7dff2ad2b2915c.js integrity="sha256-KU7okmx4Rre++ofhQgznYhB3QX1O8ZXfbH3/KtKykVw="></script>
<script src=https://www.rapatao.com/js/add-on.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LDJ57WEQPH"></script>
<script>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LDJ57WEQPH",{anonymize_ip:!0})}</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "8575ea838221496eb4ac5f867d0d5d8f"}'></script></div></body></html data-check="rapatao.com">